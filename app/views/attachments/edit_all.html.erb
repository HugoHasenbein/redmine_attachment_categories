<h2><%= l(:label_edit_attachments) %></h2> 
<script type="text/javascript" charset="utf-8">
  function changeCategoryColor(element) {
	var cloned_tag;
	if($(element).val() != null && $(element).val() != "") {
	  cloned_tag = $( "#attachment_category-" + $(element).val() ).clone();
	} else {
	  cloned_tag = $( "#attachment_category-nil").clone();
	}
	$(element.closest("tr")).find(".attachment_category").replaceWith( cloned_tag );
	$(element.closest("tr")).find(".attachment_category").removeAttr( "id" );
  }
</script>
<div attachment_categories style="display:none;">
<%- 
attachment_categories = AttachmentCategory.all
attachment_categories.each do |attachment_category| %>
<%= attachment_category_tag(attachment_category, :span, {:id => "attachment_category-#{attachment_category.id}"}) %>
<%- end %>
<%= attachment_category_tag(nil, :span, {:id => "attachment_category-nil"}) %>
</div>
<%= error_messages_for *@attachments %>

<%= form_tag(container_attachments_path(@container), :method => 'patch') do %>
  <%= back_url_hidden_field_tag %>
  <div class="box attachments">
  <table>
  <% @attachments.each do |attachment| %>
    <tr id="attachment-<%= attachment.id %>">
      <td>
		<div class="attachment_categories_column" style="<%= "width:#{@thumbnail_size}px;" %>">
		<%- if attachment.thumbnailable? %>
		  <%= thumbnail_tag_with_attachment_category( attachment ) %>
		<%- else %>
		  <%= attachment_category_tag(attachment.attachment_category, :span) %>
		<%- end %>
		</div>
      </td>
      <td><%= text_field_tag "attachments[#{attachment.id}][filename]", attachment.filename, :size => 40 %></td>
      <td>
        <%= text_field_tag "attachments[#{attachment.id}][description]", attachment.description, :size => 40, :placeholder => l(:label_optional_description) %>
        <%= javascript_tag "observeAutocompleteField('attachments_#{attachment.id}_description', '#{auto_complete_attachment_descriptions_path(@container.project)}')".html_safe %>
      </td>
      <td>
		<%- categories = AttachmentCategory.all.collect { |p| [p.name, p.id]}  %>
		<%= select_tag "attachments[#{attachment.id}][attachment_category_id]", options_for_select([['', '']] + categories, attachment.attachment_category_id), :onchange => "changeCategoryColor(this)" %>
      </td>
      <td><%= link_to l(:button_delete), attachment_path(attachment),
						:data => {:confirm => l(:text_are_you_sure)},
						:method => :delete,
						:class => 'delete icon-only icon-del',
						:title => l(:button_delete) %>
      </td>
    </tr>
  <% end %>
  </table>
  </div>
  <p>
    <%= submit_tag l(:button_save) %>
    <%= link_to l(:button_cancel), back_url if back_url.present? %>
  </p>
<% end %>
